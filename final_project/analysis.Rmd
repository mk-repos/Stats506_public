---
title: "Stats 506, F20, Final Project (Draft)"
author: "Moeki Kurita, mkurita@umich.edu"
date: "`r format.Date(Sys.Date(), '%B %d, %Y')`"
output:
  html_document:
    toc: true
    number_sections: true
---

```{r setup, include=FALSE}
# 79: -------------------------------------------------------------------------
knitr::opts_chunk$set(echo = TRUE)
options(knitr.kable.NA = '')
library(haven); library(survey); library(twang)
library(tidyverse);library(xtable); library(kableExtra)
```

This document contains a series of preliminary analyses, which will be summarized and put into a 2-page final report after the peer reviews. In this document the description of the analysis will be greatly simplified, assuming the code reviewers have a good knowledge of technical terms. The two-page final report will likely make the descriptions more readable and easier to understand.

# Introduction

This analysis primarily addresses the following question.

> Do adults in the U.S. subsidized by Medicaid use health care services more often than those with private insurance?

Medicaid is a form of public assistance in which the government pays for insurance premiums, co-payments, prescription drugs, and medical expenses for low-income people. A typical criticism of such a health care system is the suspicion that the insured's health care utilization behavior (e.g., frequency) will be altered by the fact that it is free and that health care services will be overused. Using data on the type of insurance and frequency of use of medical services available in NHANES, we will analyze whether there is any evidence to support this claim.

This kind of analysis is not possible in countries with universal health care systems, such as Japan and the United Kingdom. The question in a more general sense is whether the form of health insurance will cause any changes in people's behaviors in using health care providers.

# Data Preparation

Our analysis uses *Demographic Data*, *Health Insurance Questionnaire (HIQ)*, and *Hospital Utilization & Access to Care Questionnaire (HUQ)* available at NHANES 2017-2018. These questionnaires allow us to obtain information on the type of insurance that the subject is enrolled in and how many times the subject received health care during the previous year.

Our analysis focuses on adults over the age of 20. We also exclude cases with military health insurance, Medicare for everyone over 65 years of age, and Medicare for disabled people, as these cases are not appropriate to our purpose of measuring the effect of Medicaid. Therefore, our analysis will only analyze non-military and non-disabled individuals between the ages of 20 and 64 living in the United States.

What complicates the analysis is that the type of insurance is not mutually exclusive. A person on Medicaid may receive other state assistance, government assistance, or even have private insurance. Since the details of their private insurance are not available in NHANES, a distinction needs to be made between those whose coverage is 100% funded by their own expenses and those who use some assistance and rely partially on private insurance. We created an indicator variable to divide subjects into two groups: the (fully) unsubsidized, privately insured group and the (partly or fully) subsidized group, which we collectively regard those receiving either or all of Medicare, state assistance, or government assistance as subsidized. We mostly use this summary variable.

```{r data_loader}
demo_2018 = read_xpt("./data/DEMO_J.XPT")
insurance_2018 = read_xpt("./data/HIQ_J.XPT")
hospital_2018 = read_xpt("./data/HUQ_J.XPT")
insurance_2016 = read_xpt("./data/HIQ_I.XPT")

demo_2018 = demo_2018 %>% 
  select(id = SEQN,
         exam_status = RIDSTATR, # some variable (pregnancy) only available
                                 # among those examined
         gender = RIAGENDR,
         age = RIDAGEYR,
         race = RIDRETH1,
         pregnancy = RIDEXPRG, # pregnancy at the time of the exam
         education = DMDEDUC2, # only focus on adults (20+)
         fm_income = INDFMIN2,  # family income
         psu = SDMVPSU,
         strata = SDMVSTRA,
         weight = WTINT2YR,
         weight_mec = WTMEC2YR)

insurance_2018 = insurance_2018 %>% 
  select(id = SEQN,
         insurance = HIQ011, # covered by any health insurance
         private = HIQ031A,
         medicaid = HIQ031D,
         chip = HIQ031E,
         state = HIQ031H, #  covered by state-sponsored health plan
         other_gov = HIQ031I, # covered by other government insurance
         medicare = HIQ031B,
         military = HIQ031F
         )

hospital_2018 = hospital_2018 %>% 
  select(id = SEQN,
         health = HUQ010, # general health condition
         hospital = HUQ051) # times receive healthcare over past year
```

Note that we link the type of insurance **at the time of the survey** to the frequency of use **during the previous year**. The subjects may not have used their current insurance during the previous year. By matching the same variables from the previous survey, it is possible to analyze only those who had the same insurance in the previous year as now. We will try this approach in the final report.

```{r}
# May use insurance status as of the previous year in the future analysis
# to match the insurance status of the subjects between 2015-2016 & 2017-2018

# insurance_2016 = insurance_2016 %>% 
#   select(id = SEQN,
#          insurance_16 = HIQ011,
#          private = HIQ031A,
#          medicaid = HIQ031D,
#          chip = HIQ031E,
#          state = HIQ031H,
#          other_gov = HIQ031I,
#          medicare = HIQ031B,
#          military = HIQ031F
#          )
```

## Clean demographic

```{r}
demo_2018 = demo_2018 %>% 
  filter(age >= 20 & age < 65) %>% # exclude children and elderly
  mutate(female = ifelse(gender == 2, 1, 0),
         race = factor(race, c(1,2,3,4,5), c("Mexican", "Hispanic", "White",
                                             "Black", "Other")),
         college = factor(ifelse(education == 4 | education == 5, 1, 0)),
         fm_income = ifelse(fm_income == 12 | fm_income == 13
                            | fm_income == 77 | fm_income == 99,
                            NA, fm_income),
         # Low = $0-$24,999,  Mid = $25,000-54,999, High = $55,000 & over
         fm_income_shorten = ifelse(fm_income == 1 | fm_income == 2
                                    | fm_income == 3 | fm_income == 4
                                    | fm_income == 5, 1,
                             ifelse(fm_income == 6 | fm_income == 7
                                    | fm_income == 8, 2,
                             ifelse(fm_income == 9 | fm_income == 10
                                    | fm_income == 14 | fm_income == 15, 3, 
                             fm_income))),
         fm_income_shorten = factor(fm_income_shorten, c(1, 2, 3),
                                    c("Low", "Mid", "High"))) %>% 
  select(-gender, -education)
```

## Merge insurance data

```{r, warning=FALSE}
df = demo_2018 %>% 
  left_join(insurance_2018, by = c("id")) %>% 
  filter(insurance == 1) %>%  # exclude individuals without any insurance
  filter(is.na(military)) %>% # exclude military person
  filter(is.na(medicare)) # excludes disabled people under 64 with Medicare 

df = df %>% 
  mutate(insurance = factor(ifelse(insurance == 7 | insurance == 9, NA,
                            ifelse(insurance == 1, 1, 0))),
         private = factor(ifelse(private == 77 | private == 99, NA, private )),
         medicaid = factor(medicaid),
         chip = factor(chip),
         state = factor(state),
         other_gov = factor(other_gov),
         military = factor(military),
         subsidized = factor(ifelse(!is.na(medicaid) | !is.na(chip) 
                                    | !is.na(state) | !is.na(other_gov),
                                    1, 0)) ) %>% 
  # create new variable indicating whether subsidized or 100% private
  mutate(insurance_cln = factor(ifelse(!is.na(private) & subsidized == 0,
                                1, ifelse(subsidized == 1, 2, NA)),
                                c(1, 2), c("private", "subsidized")) ) %>% 
  select(-medicare, -chip, -military)

# recode with 0-1
df = df %>% 
  mutate_at(c("private", "medicaid", "state", "other_gov"),
            funs(ifelse(is.na(.),0,.)))

# drop NA cases on the new indicator variable
df = df %>%
  drop_na(insurance_cln)
```

## Merge hospital data

```{r}
df = df %>% 
  left_join(hospital_2018, by = c("id")) %>% 
  mutate(health = ifelse(health == 7 | health == 9, NA, health),
         hospital = ifelse(hospital == 77 | hospital == 99, NA, hospital))

# drop NA cases on the variable of interest
df = df %>% 
  drop_na(health, hospital)
```

## Other Modification

```{r}
df = df %>% 
  mutate(agec = age - mean(age))
```


## Output cleaned dataset

Variables such as `pregnancy` tied to MEC exam remain `NA` because they will be analyzed differently than other variables.

```{r}
write_csv(df, "./data/cleaned.csv")
write_dta(df, "./data/cleaned.dta")
```

```{r, echo=FALSE}
df %>% 
  select(-insurance) %>% 
  DT::datatable(extensions = 'FixedColumns',
            options = list(dom = 't', scrollX = TRUE, scrollCollapse = TRUE))
```

# Test for Association with Survey Design

See Stata code `./analysis.do`

The resulting table is embedded below. This table will be reformatted in the final report.

We find that people who receive assistance, such as Medicaid, use the hospital more often.
* category "8" means "use hospitals 16 times or more"

```{r, echo=FALSE, warning=FALSE}
tbl = read_csv("./data/stata_tabulate.csv", col_types = cols())
tbl %>% 
  select(`# Times Hospital` = 1, Private = 2, Subsidized = 4, Total = 6) %>% 
  slice(-c(1,2)) %>%
  mutate_at(vars(2:4), list(as.numeric)) %>%
  kable(format = 'html', escape = FALSE, align = 'c', digits = 3) %>%
  kable_paper("hover", full_width = FALSE)
```

# Ordinal Logistic Regression with Survey Design

See Stata code `./analysis.do`

The resulting regression table is embedded below.  This table will be reformatted in the final report.

The two way table above does not eliminate biases like some people (such as older people, poorer people, etc.) are less healthy and more likely to use hospitals in the first place. Therefore, we performed an ordinal logistic regression, where we tried to control for demographic variables.

Again, we find that receiving Medicaid and other benefits had a positive impact on the number of hospital visits.

```{r, echo=FALSE}
reg_tbl = read_dta("./data/stata_ologit.dta")
reg_tbl %>% 
  select(-N) %>%
  slice(1:20) %>% 
  kable(format = 'html', escape = FALSE, align = 'c', digits = 3) %>%
  kable_paper("hover", full_width = FALSE)
```

# Ordinal Logistic Regression with Inverse-Probability Weighting

We also analyzed the impact of the treatment (Medicaid receipt) using propensity scores as well. Again, a statistically significant impact was observed.

```{r}
# recode indicator variable to 0-1
# 1 indicates the subject receive medicaid. state/government assistance
df = df %>% 
  mutate(treatment = ifelse(insurance_cln == "subsidized", 1, 0))
# dataframe for IPW
df_dropped = df %>% 
  select(hospital, treatment, agec, female, race, college, health, fm_income)
```

```{r}
boosted.mod <- twang::ps(treatment ~ agec + female + race + college + health + fm_income,
                  data=as.data.frame(df_dropped),
                  estimand = "ATE",
                  n.trees = 5000, 
                  interaction.depth=2, 
                  perm.test.iters=0, 
                  verbose=FALSE, 
                  stop.method = c("es.mean"))
# summary(boosted.mod)
```

```{r}
summary(boosted.mod$gbm.obj,
        n.trees=boosted.mod$desc$es.mean.ATE$n.trees, 
        plot=FALSE)
```

```{r, warning=FALSE}
df_dropped$boosted <- get.weights(boosted.mod)
```

```{r}
hist(df_dropped$boosted)
```

```{r}
plot(boosted.mod, plots=3)
```

```{r}
design <- svydesign(ids=~1, weights=~boosted, data=df_dropped)
ologit <- svyolr(factor(hospital) ~ treatment, design=design)
summary(ologit)
```

# Account for pregnancy

In addition to the elderly and poor, pregnant women should also increase their use of hospitals. Therefore, we limited our analysis to women only and controlled for pregnancy.

Since pregnancies are confirmed by the MEC exam rather than by the NHANES general interview, we can only use observations that took the MEC exam. We only retain observations where the subject is determined to be pregnant or not pregnant on the MEC exam.

```{r}
pregnancy = df %>% 
  # drop female subjects with unknown pregnancy status
  filter(exam_status == 2) %>% 
  # retain men, drop NA
  filter(!is.na(pregnancy)) %>%
  # drop women with unknown pregnancy status
  filter(pregnancy != 3) %>% 
  mutate(pregnancy = factor(ifelse(pregnancy == 2, 0, pregnancy)))
```

```{r}
pregnancy_dropped = pregnancy %>% 
  select(hospital, treatment, agec, race, college, health, fm_income, pregnancy)
```

```{r}
boosted.mod <- twang::ps(treatment ~ agec + race + college + health
                         + fm_income + pregnancy,
                  data=as.data.frame(pregnancy_dropped),
                  estimand = "ATE",
                  n.trees = 5000, 
                  interaction.depth=2, 
                  perm.test.iters=0, 
                  verbose=FALSE, 
                  stop.method = c("es.mean"))
# summary(boosted.mod)
```

```{r}
summary(boosted.mod$gbm.obj,
        n.trees=boosted.mod$desc$es.mean.ATE$n.trees, 
        plot=FALSE)
```

```{r, warning=FALSE}
pregnancy_dropped$boosted <- get.weights(boosted.mod)
```

```{r}
hist(pregnancy_dropped$boosted)
```

```{r}
plot(boosted.mod, plots=3)
```

```{r}
design <- svydesign(ids=~1, weights=~boosted, data=pregnancy_dropped)
ologit <- svyolr(factor(hospital) ~ treatment, design=design)
summary(ologit)
```